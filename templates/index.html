{% extends "base.html" %}

{% block content %}
<section class="panel">
  <div class="panel-header">
    <h2>{{ status }} Properties</h2>
    <p>Total: {{ properties | length }}</p>
  </div>
  <div class="grid">
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Created</th>
            <th>Agent</th>
            <th>Address</th>
            <th>Price</th>
            <th>Beds</th>
            <th>Baths</th>
          </tr>
        </thead>
        <tbody>
          {% for property in properties %}
          <tr class="property-row" data-property='{{ property | tojson }}'>
            <td>{{ property.created_at_display }}</td>
            <td>{{ property.agent_name }}</td>
            <td>{{ property.address or "-" }}</td>
            <td>{{ property.price or "-" }}</td>
            <td>{{ property.beds or "-" }}</td>
            <td>{{ property.baths or "-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="detail" id="detail">
      <h3>Details</h3>
      <p>Select a property row to view details.</p>
    </div>
  </div>
</section>

<script>
  const rows = document.querySelectorAll(".property-row");
  const detail = document.getElementById("detail");
  const clients = {{ clients | tojson }};

  const renderDetail = (property) => {
    const clientOptions = clients
      .map((client) => `<option value="${client.id}">${client.name}</option>`)
      .join("");

    detail.innerHTML = `
      <h3>Property Details</h3>
      <div class="detail-grid">
        <div><strong>Agent</strong><span>${property.agent_name}</span></div>
        <div><strong>Created</strong><span>${property.created_at}</span></div>
        <div><strong>Link</strong><span>${property.link || ""}</span></div>
        <div><strong>Address</strong><span>${property.address || ""}</span></div>
        <div><strong>Size</strong><span>${property.size || ""}</span></div>
        <div><strong>Price</strong><span>${property.price || ""}</span></div>
        <div><strong>Beds</strong><span>${property.beds || ""}</span></div>
        <div><strong>Baths</strong><span>${property.baths || ""}</span></div>
      </div>
      <div class="detail-notes">
        <strong>Notes</strong>
        <p>${property.notes || ""}</p>
      </div>
      <div class="detail-notes">
        <strong>Raw Message</strong>
        <pre>${property.raw_message || ""}</pre>
      </div>
      ${property.status === "REVIEWED" ? "" : `
        <div class="assign">
          <label>Assign Client</label>
          <select id="clientSelect">
            <option value="">Select client</option>
            ${clientOptions}
          </select>
          <button id="assignButton">Assign</button>
          <span id="assignStatus" class="assign-status"></span>
        </div>
      `}
    `;

    if (property.status !== "REVIEWED") {
      document.getElementById("assignButton").addEventListener("click", async () => {
        const clientId = document.getElementById("clientSelect").value;
        const statusEl = document.getElementById("assignStatus");
        if (!clientId) {
          statusEl.textContent = "Select a client.";
          return;
        }
        statusEl.textContent = "Assigning...";
        const response = await fetch(`/properties/${property.id}/assign-client`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ client_id: clientId }),
        });
        if (response.ok) {
          statusEl.textContent = "Assigned.";
          window.location.reload();
        } else {
          statusEl.textContent = "Failed to assign.";
        }
      });
    }
  };

  rows.forEach((row) => {
    row.addEventListener("click", () => {
      const property = JSON.parse(row.dataset.property);
      renderDetail(property);
    });
  });
</script>
{% endblock %}
